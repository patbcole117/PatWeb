Gyokuro LLC                                                      Patrick Coleman
                                                                 2021/07/17

Title: Homenet Project Outline
Author: Patrick Coleman
Date: July 17th, 2021

Introduction
     Homenet is the name of my home network. Homenet has been designed to be 
     simple and flexible. Gyokuro LLC is basically an research and 
     development company; as such, flexibility is paramount. I wanted to 
     ensure that Homenet is structured in a way that allows me to create and 
     remove VMs quickly and easily without worrying about expanding or contracting
     networks.
     
Physical Devices
     Homenet is comprised of 5 physical devices. Endpoint devices (3) are named 
     after Nintendo-64 games. Networking devices (2) are named after planets; 
     (or minor-planets)

     Dell Poweredge R720 (RAYMAN):
          RAYMAN is my Dell Poweredge R720. This has Proxmox installed on
          bare-metal. RAYMAN is where most of my network resides virtually.
          As of now there are about 7 Linux machines and a pfSense router
          running on it; all virtual. RAYMAN has a little over 2TB of local 
          storage for provisioning VMs and storing images. The are are 3 
          SAS-HDDs running in a RAID-5 configuration.
          
     Desktop_1 (GOLDENEYE):
          GOLDENEYE is my old desktop. I repurposed it into a SAN for 
          backups. GOLDENEYE runs Free-NAS and delivers block-storage over 
          my network using CHAPS authentication. RAYMAN uses GOLDENEYE as 
          a backup storage location. GOLDENEYE has 5 1TB ZFS-formatted drives
          They are in RAID-Z1 configuration which reduces the pool to around
          3.5TB of storage.
               
     Desktop_2 (PERFECT-DARK):
          PERFECT-DARK is my primary desktop. I don't actually do much work 
          on this machine, however I do use it to remote into my virtual 
          Ubuntu workstation and manage networking devices. I like to keep 
          my home device simple, so there is nothing on here really, other 
          than games and Mozilla.
      
      Netgear-AC1200 Router (venus):
          venus is the gateway device between my LAN and the WAN.
      
      Netgear-GS108PEv3 Switch (pluto):
          pluto is a switch that connects all my physical devices together.
          
      Below is a diagram of my physical network:
               
Networking
     Physical vs Virtual
          As alluded to prior, Homenet is divided among physical and virtual 
          devices. The virtual portion of my network is much larger than the 
          physical portion. On RAYMAN is a virtual pfSense router that divides 
          my physical network from my virtual one. This means that in order to 
          host web servers on my virtual network, the server must be double 
          NATed (or double port-forwarded) to be able to function correctly.
          
     IP-Schema
          I have put a lot of thought into the IP-Schema of Homenet. I wanted to
          achieve a "set it and forget it" feel. To do this, each network has 
          a significant amount of room to grow and VMs are placed in such a way
          to allow networks to be segmented on the fly, If i determine that a 
          service needs further isolation. Presently the IP-Schema looks as follows:
          
          LAN (physical network):  192.168.0.0/24
          VLAN-8:                  10.8.0.0/24
          VLAN-16:                 10.16.0.0/24
          VLAN-24:                 10.24.0.0/24
          VLAN-32:                 10.32.0.0/24    
          
          IPs assigned to devices placed into VLANS begin at .16; I want to 
          ensure that like-devices are segmented into a potential-VLSM subnet. 
          Since the pfSense Router (neptune) takes the .1 IP in each subnet, I 
          do not want to place a Linux-server into the .1 - .15 range. This 
          allows me, if I so desire, to create a new subnet, VLAN-9 perhaps, at 
          10.8.0.16/28. the like-devices would run from .16 - .29 and neptune would
          be placed at 10.8.0.30. This schema allows me to squeeze or expand 
          networks as I please without having to re-key server IPs.              
          
     VLANS
          VLAN-8 (dev-dmz):
               VLAN-8 is the development DMZ. This VLAN is available to host 
               development servers that can be accessible from the outside.
          
          VLAN-16 (dev-internal):
               VLAN-16 is the development internal network. This VLAN is for VMs
               that should not be accessible from the WAN but are accessible by 
               VLAN-8
               
          VLAN-24 (prod-dmz):
               VLAN-24 is the production DMZ. This VLAN hosts servers that are 
               accessible from the outside network.
               
          VLAN-32 (prod-internal):
               VLAN-32 is the production internal network. This VLAN hosts VMs 
               that are not accessible by the WAN but are accessible by VLAN-24.

Disaster Recovery:
     In the event that RAYMAN (Proxmox) fails, the entire network will need to 
     be rebuilt. RAYMAN used to run RAID-0, however after experiencing a drive 
     failure I decided to use RAID-5 after rebuilding. RAID-5 should protect 
     against drive failures. However in the event where RAID-5 does not suffice,
     below is instructions for a manual rebuild when only GOLDENEYE backups are 
     available (RAID rebuild wont work).
     
          1. Replace the HDDs in RAYMAN. Configure them for RAID-5.
          2. Use Etcher to create a bootable USB for Proxmox.
          3. Reinstall Proxmox on RAYMAN, check diagrams for networking information.
          4. Add GOLDENEYE as an isci target using the Proxmox GUI.
          5. Log into the Proxmox shell.
          6. Mkdir /mnt/iscsi/GOLDENEYE/
          7. Mount <iscsi-drive> /mnt/iscsi/GOLDENEYE/
          8. Add directory storage in Proxmox GUI, use /mnt/iscsi/GOLDENEYE/ for 
               target.
          9. Validate backups are available by checking the mounted storage in the
               Proxmox GUI.
          10. crontab -e
          11. @reboot sleep 60 && mount <iscsi-drive> /mnt/iscsi/GOLDENEYE/
          12. Upload ISO files for VM images (stored on PERFECT-DARK).
          13. Create Linux Bridge (vmbr1) in the Proxmox GUI, use a different 
               interface than vmbr0. Check the vm-aware box.
          14. Reboot RAYMAN.
          15. Restore vm-101 (neptune).
          16. Restore any additional VMs.
          17. Create templates if needed.
          18. Create new backup schedule for VMs.
          19. Enable email alerts in the Proxmox shell.
          
          Note that it is possible to backup the host configuration of Proxmox,
          however after attempting it it actually seems faster to just manually
          restore the configurations. If my Proxmox configurations become very
          complex i may reconsider; but for now Ill opt to manually restore 
          configurations.
